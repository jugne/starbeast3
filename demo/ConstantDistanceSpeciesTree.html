<html>



	<head>

		<style>

			@import url('https://fonts.googleapis.com/css?family=Source+Sans+Pro');

			body {
				font-family: "Source Sans Pro", "Arial"; 
				background-color:#d3d3d3;
				width:100%;
			}


			table {
			   	%font-family: Courier New; 
				font-size:16px;
				position:relative;
			}

			table td {
				margin:0;
			}

			table {
			   	border-collapse: collapse;
			}

			.node {
				cursor:pointer;
			}

			.button{
				border-radius:5px;
				padding: 5;
				margin-right:10px;
				margin-left:10px;
				border-color:black;
				border-style:solid;
				border-width:1px;
				cursor:pointer;
			}


			.button:hover{
				color:white;
				background-color:#DB5079;
			}


			.dialog{

				z-index:1000;
				position:fixed;
				width:50%;
				text-align:center;
				margin-left:25%;
				top:10vh; 
				%min-height:200px;
				text-align:center;
				background-color:#DB5079; 
				padding: 10 10; 
				%margin:auto;
				border-radius: 5px;
				box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
			}


			.dialog.toTheSide{
				position:relative;
				margin-left:0;
				%top:10vh;
				width:100%;
				margin-bottom:100;
			}


			.dialog_inner{
				background-color: white; 
				padding: 10 10; 
				text-align:center; 
				font-size:15; 
				overflow-y:auto
			}


			.glowing {
				%filter: invert(100%);
				background-color:orange;
				color:white; 
				border-radius:5px;
				border-color: #FFFFB2; 
				 -webkit-box-shadow: 0 0 10px #FFFFB2; 
				   -moz-box-shadow: 0 0 10px #FFFFB2; 
				    box-shadow: 0 0 10px #FFFFB2; 
			}


			.annoyingFlash{
				color:red;
				position:fixed;
				font-family: "Comic Sans";
				top: 50%;
				bottom: 50%;
				font-size: 5em; 
				text-align: center;
				width:100%;
			}



						

		</style>

		
	<script type="text/x-mathjax-config">
	  MathJax.Hub.Config({
	    tex2jax: {
	      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
	      processEscapes: true
	    }
	  });
	</script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
		<script language='JavaScript' type='text/JavaScript' src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="icytree-master/js/tree.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="icytree-master/js/treeparsing.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="src/drawTrees.js"></script>
		<script language='JavaScript' type='text/JavaScript' src="lib/velocity.min.js"></script>
		<script language='JavaScript' type='text/JavaScript' src='lib/d3.v5.min.js'></script> 
		<script>


			function init(){


				NODE_SIZE = 10;
				GENE_NODE_SIZE = 4;
				SVG_TOP_MARGIN = 20;
				SVG_BOTTOM_MARGIN = 20;
				SVG_LEFT_MARGIN = 20;
				SVG_RIGHT_MARGIN = 20;
				SPECIES_LEAVES = [];
				textLabelPadding = 5;
				SPECIES_TREE = null;
				GENE_TREES = [];
				MAX_TREE_HEIGHT = 0;

				SVG_HEIGHT = 800;
				SVG_WIDTH = 800;
				GAP_BETWEEN_SUBTREES = 0;

				var svg = $("#tree");
				svg.html("");
				svg.height(SVG_HEIGHT);
				svg.width(SVG_WIDTH);

				
				yScaler = 1;
				BURNIN = 0.1;
				NUM_AFTER_BURNIN = 0;



				// Operator
				SPECIES_TREE_X = null;
				ALPHA = 0; 		
				ALPHA_WINDOW = 0.003;
				$("#windowInput").val(ALPHA_WINDOW);
				revALPHA = 1;

				loadFileAsString("trees/calibrated_S8_G30_2.species.trees", function(str1) { loadFileAsString("trees/calibrated_S8_G30_2.gene1.trees", function(str2) { loadFileAsString("trees/starbeast3_UCLN.gene29.trees", function(str3) {

					SPECIES_TREES_ALL = getTreesFromString(str1);

					GENE_TREES_ALL = [];
					GENE_TREES_ALL.push(getTreesFromString(str2));
					GENE_TREES_ALL.push(getTreesFromString(str3));

					NTREES = SPECIES_TREES_ALL.length;
					renderTrees();

				}); }); });

			}

			function updateAlphaWindow() {
				ALPHA_WINDOW = parseFloat($("#windowInput").val());
			}

			function nextTree() {
				NUM_AFTER_BURNIN++;
				renderTrees();

			}


			function prevTree() {
				NUM_AFTER_BURNIN--;
				renderTrees();

			}


			function renderTrees() {


				
				SPECIES_TREE_X = null;
				unhover();
				$(".dialog").remove();

				
				GENE_TREES = [];
				var treeNum = Math.floor(NTREES * BURNIN) + 1 + NUM_AFTER_BURNIN;


				SPECIES_TREE = SPECIES_TREES_ALL[treeNum];
				SPECIES_TREE.geneNodeMap = {};
				//console.log("speciesTree", SPECIES_TREE);
	

				var gene_tree1 = GENE_TREES_ALL[0][treeNum];
				GENE_TREES.push(gene_tree1);

				var gene_tree2 = GENE_TREES_ALL[1][treeNum];
				GENE_TREES.push(gene_tree2);

				console.log("gene_tree1", gene_tree1);
				console.log("gene_tree2", gene_tree2);


				var svg = $("#tree");
				svg.html("");
				svg.height(SVG_HEIGHT);
				svg.width(SVG_WIDTH);


				$("#treeNum").html(treeNum);

			


				// Get max tree height 
				MAX_TREE_HEIGHT = Math.max(Math.max(SPECIES_TREE.root.height, gene_tree1.root.height), gene_tree2.root.height);
				HEIGHT_SCALE = (SVG_HEIGHT - SVG_BOTTOM_MARGIN - SVG_TOP_MARGIN) / MAX_TREE_HEIGHT;

				var totalNAtLeaves = 0;
				SPECIES_LEAVES = [];
				for (var i = 0; i < SPECIES_TREE.nodeList.length; i ++) {
				
					var node = SPECIES_TREE.nodeList[i];
					node.rate = node.annotation["branchRates.Species"] = null ? 1 : parseFloat(node.annotation["branchRates.Species"]);
					node.populationsize = node.annotation["pop"] == null ? 1 : parseFloat(node.annotation["pop"]);
					node.coords = { bottomLeft: {x: -1, y: -1}, bottomRight: {x: -1, y: -1}, topLeft: {x: -1, y: -1}, topRight: {x: -1, y: -1}, dashed: {left: -1, right: -1}, xrange: {left: -1, right: -1} };
					node.coordsStored = JSON.parse(JSON.stringify(node.coords));
					node.branchToGeneNodeMap = []; // Maps species branch to gene nodes
					node.nodeToGeneBranchMap = []; // Maps species nodes to gene branches
					
					for (var g = 0; g < GENE_TREES.length; g++){
						node.branchToGeneNodeMap[g] = {};
						node.nodeToGeneBranchMap[g] = {};
					}

					//console.log(i, SPECIES_TREE.nodeList[i].populationsize);
					
					if (node.label != null) {	
						node.height = 0;
						totalNAtLeaves += node.populationsize;
						SPECIES_LEAVES.push(node);
					}
				}
				
				GAP_BETWEEN_SUBTREES = 0.2 * totalNAtLeaves / SPECIES_LEAVES.length;
				
				planSpeciesTree(SPECIES_TREE.root);
				scaleTreeRanges(SPECIES_TREE, SVG_LEFT_MARGIN, SVG_HEIGHT-SVG_BOTTOM_MARGIN, SVG_WIDTH-SVG_RIGHT_MARGIN, SVG_TOP_MARGIN);
	
				console.log("SPECIES_TREE", SPECIES_TREE);
				drawASpeciesTree(svg, SPECIES_TREE, "speciestree", SPECIES_TREE.root);
				storeTree(SPECIES_TREE.root);

			

				// Draw the gene tree
				for (var g = 0; g < GENE_TREES.length - 1; g++){

					var gene_tree = GENE_TREES[g];
					//gene_tree.speciesNodeMap = {};
					
		
					// Get the leaves
					var leaves = [];
					for (var i = 0; i < gene_tree.nodeList.length; i ++) {
						var geneNode = gene_tree.nodeList[i];
						geneNode.speciesNodeMap = null;
						geneNode.coords = { cx: -1, cy: -1, x: [], y: [], strokeWidths: [] };
						geneNode.coordsStored = JSON.parse(JSON.stringify(geneNode.coords));
						
						
						if (geneNode.children.length == 0) {
							leaves.push(geneNode);
							geneNode.height = 0;
						}
					}
					
					
					// Map the leaves to species leaves
					for (var i = 0; i < SPECIES_LEAVES.length; i ++){

						var gene_leaves_for_species = [];
						for (var j = 0; j < leaves.length; j ++) {
							var leaf = leaves[j];
							var speciesOfGene = leaf.label.split("_")[1];
							//console.log(speciesOfGene, SPECIES_LEAVES[i].label);
							if (SPECIES_LEAVES[i].label == speciesOfGene) {
								SPECIES_LEAVES[i].branchToGeneNodeMap[g][leaves[j].id] = leaves[j];
								SPECIES_LEAVES[i].nodeToGeneBranchMap[g][leaves[j].id] = leaves[j];
								
								leaves[j].speciesNodeMap = SPECIES_LEAVES[i]
								//gene_leaves_for_species.push(leaf);
							}

						}


					}
					

					//drawGeneTree(svg, "gene" + g, gene_tree, gene_tree.root, true);
					buildGeneTreeSpeciesTreeMap(g, gene_tree.root);
					planGeneTree(g, gene_tree.root);
					drawAGeneTree(svg, "gene" + g, gene_tree.root, SPECIES_TREE);
					console.log("gene_tree", gene_tree);
					console.log("SPECIES_TREE", SPECIES_TREE);
					

				}


				

			




			}


			function operate(step = 1) {

				


				var desc = "";
				switch(step) {

					case 1: {
						restoreTree(SPECIES_TREE.root);
						if (SPECIES_TREE_X != null) moveSpeciesTreeNode(SPECIES_TREE, SPECIES_TREE_X);
						$("#sampledAlpha").html("");
						desc = `Sample an internal node $x$ from the species tree $S$. Let $t_x$, $r_x$, and $N_x$ be its time, rate, and effective population size, respectively.`;
						//desc = `$x$`;
						break;
					}

					case 2: {
						desc = `Sample $\\alpha \\sim \\text{Uniform}(-w, w)$ for some window size $w$.`;
						break;
					}

					case 3: {
				
						desc = `Propose a new node time for $x$ as <br><br> $ {t_x}^\\prime \\leftarrow  t_x + \\alpha$ <br><br> Ensure that $\\max\\{t_{L}, t_{R} \\} < {t_x}^\\prime < t_{P}$. `;
						break;
					}
					case 4: {

						if (ALPHA != 0 && revALPHA == 1) moveSpeciesTreeNode(SPECIES_TREE_X, ALPHA)
						desc = `Propose new rates for the following species tree nodes: <br><br> 
							{r_x}^\prime &\leftarrow r_x \times  \frac{t_{P} - t_x}{t_{P} - {t_x}^\prime } \tag{$f_2$} <br> 
							{r_{L}}^\prime &\leftarrow r_{L} \times  \frac{t_x - t_{L}}{{t_x}^\prime - t_{L} } \tag{$f_3$} <br> 
							{r_{R}}^\prime &\leftarrow r_{R} \times  \frac{t_x - t_{R}}{{t_x}^\prime - t_{R} } \tag{$f_4$}`;
						break;
					}
					case 5: {
						desc = ``;
						break;
					}
					case 6: {
						desc = ``;
						break;
					}

					case 7: {
						desc = ``;
						break;
					}


				}


				$(".dialog").remove();
				$("body").append(getdialogTemplate(step, desc));
				//var math=MathJax.Hub.getAllJax("dialogDesc")[0];
				//MathJax.Hub.Queue(["Text",math,desc]); 

				

			}


			function doOperation(step = 1){


				// Move the template
				jQuery("#operatorDialog").detach().appendTo("#operatorPanel");
				$("#operatorDialog").addClass("toTheSide");
				$("#dialogBtn").html("Next");
				$("#dialogBtn").attr("onclick", "operate(" + (step + 1) + ")");

				$("#dialogBtnRev").hide(0);
				switch(step) {

					case 1: {
						
						// Sample a node
						var speciesTreeInternalNodes = [];
						for (var i = 0; i < SPECIES_TREE.nodeList.length; i ++) {
							if (SPECIES_TREE.nodeList[i].parent != null && SPECIES_TREE.nodeList[i].children.length == 2) {
								speciesTreeInternalNodes.push(SPECIES_TREE.nodeList[i]);
							}
						}
						SPECIES_TREE_X = speciesTreeInternalNodes[Math.floor(Math.random() * speciesTreeInternalNodes.length)];
						highlightNode(SPECIES_TREE_X.htmlID + "_P");
						break;
					}

					case 2: {

						// Sample alpha
						ALPHA = roundToSF(Math.random() * 2 * ALPHA_WINDOW - ALPHA_WINDOW);
						$("#sampledAlpha").html(ALPHA);

						makeItGlow($("#sampledAlpha").parent());

						break;
					}

					case 3: {

						revALPHA = -1;
						$("#dialogBtnRev").show(0);
						$("#dialogBtnRev").click(function() {
							if (revALPHA == -1) restoreTree(SPECIES_TREE_X, ALPHA * revALPHA);
							else restoreProposedTree(SPECIES_TREE_X, ALPHA * revALPHA);
							moveSpeciesTreeNode(SPECIES_TREE, SPECIES_TREE_X);
							revALPHA *= -1;
						});


						//console.log(SPECIES_TREE_X, SPECIES_TREE_X.height, SPECIES_TREE_X.height + ALPHA, SPECIES_TREE_X.parent.height, SPECIES_TREE_X.children[0].height, SPECIES_TREE_X.children[1].height);

					


						var accepted = proposeMoveSpeciesTreeNode(SPECIES_TREE_X, ALPHA);
						
						if (!accepted) {
						
							// Reject
							addAnnoyingFlashMessage("Rejected");
							$("#dialogDesc").append(`<br><br><b>Proposal rejected. Try again.</b>`);
							$("#dialogBtn").hide(0);
							console.log("Reject");

						}
						
						moveSpeciesTreeNode(SPECIES_TREE, SPECIES_TREE_X);



						break;
					}
					case 4: {

						break;
					}
					case 5: {

						break;
					}
					case 6: {

						break;
					}

					case 7: {

						break;
					}

				}


			}



			function getdialogTemplate(stepNum, desc){
				return `
						<div id="operatorDialog" class="dialog">
							<div class="dialog_inner">
							<h2>Step ` + stepNum + `</h2>

								<div id="dialogDesc" style="font-size:120%">` + desc + `</div><br>
								
								
								<span id="dialogBtn" onclick=doOperation(` + stepNum + `) style="float:right" class="button">Do it</span>
								<span id="dialogBtnRev" style="display:none; float:right" class="button">Undo</span>
							</div>
						</div>

					`;

			}



			function addAnnoyingFlashMessage(msg) {

				$("body").append(`<div class="annoyingFlash">` + msg + `</div>`);


				$(".annoyingFlash").animate({
					fontSize: "200em",
					color: "yellow"
			    	}, 2000);

				setTimeout(function() {
					$(".annoyingFlash").remove();
				}, 2000);

			}
			




			var drawGeneTree = function(svg, treename, tree, node, root = false) {


				
				var HEIGHT_SCALE = (SVG_HEIGHT - SVG_BOTTOM_MARGIN - SVG_TOP_MARGIN) / MAX_TREE_HEIGHT;
				//console.log("node", node);

				// Leaf node. Draw branch and return x,y values of parent node
				if (node.children.length == 0){

					//console.log("leaf", node.label, node.id);
					var id = "node_" + treename + "_" + node.id;

					var leafSvgId = "node_" + treename + "_" + node.id;
					
					var y = parseFloat($("#" + leafSvgId).attr("cy"));
					var x = parseFloat($("#" + leafSvgId).attr("cx"));
					
					//var id = leafSvgId + "_branch";

					

					return {x: x, y: y, id: id, name: node.id + ", " + node.label};

				}


				
				var id = "node_" + treename + "_" + node.id;

				// Internal/root node. Find the (x,y) of its two shoulders and draw the shoulders. Then draw its parent branch
				var r_left = drawGeneTree(svg, treename, tree, node.children[0]);
				var r_right = drawGeneTree(svg, treename, tree, node.children[1]);

				var thisHeight = SVG_HEIGHT - HEIGHT_SCALE*node.height - SVG_BOTTOM_MARGIN;
				var thisX = (r_left.x + r_right.x) / 2;



				// Draw a line from the left child to this node
				drawSVGobj(svg, "line", {class: "branch", id: r_left.id + "_branch", x1: r_left.x, y1: r_left.y, x2: thisX, y2: thisHeight, style: "stroke:#7950DB; stroke-width:1px"});


				// Draw a line from the right child to this node
				drawSVGobj(svg, "line", {class: "branch", id: r_right.id + "_branch", x1: r_right.x, y1: r_right.y, x2: thisX, y2: thisHeight, style: "stroke:#7950DB; stroke-width:1px"});

				

				// Draw the node
				drawSVGobj(svg, "circle", {class: "genenode", id: id, cx: thisX, cy: thisHeight, fill: "#7950DB", r:SPECIES_NODE_SIZE, name: node.id }, "", true);


				return {x: thisX, y: thisHeight, id: id, name: node.id};


			}







			function drawSVGobj(svg, type, attr, val = null, isNode = false, addBackground = false){

				//console.log("attr", attr);
				var newObj = document.createElementNS('http://www.w3.org/2000/svg', type);
				for (var a in attr){
					if (a == "text_anchor") newObj.setAttribute("text-anchor", attr[a]);
					else if (a == "alignment_baseline") newObj.setAttribute("alignment-baseline", attr[a]);
					else if (a == "stroke_dasharray") newObj.setAttribute("stroke-dasharray", attr[a]);
					else newObj.setAttribute(a, attr[a]);
				}
				if (val != null) newObj.innerHTML = val;



				// Set some of the styles as attributes because safari and IE do not like styles for svgs
				var styles = getComputedStyle(newObj);
				//if (styles.fill != null) newObj.setAttribute("fill", styles.fill);
				if (styles.stroke != null) newObj.setAttribute("stroke", styles.stroke);
				if (styles["stroke-width"] != null) newObj.setAttribute("stroke-width", styles["stroke-width"]);
				if (isNode) newObj.setAttribute("class", "node");
				//console.log(styles["stroke-width"]);


				svg.append(newObj);

				
				if (isNode && attr.id != null){
					$("#" + attr.id).hover(function() { hoverNode(attr.id) },  function() {  });
				}
				
				
				// Add a background box behind the label
				if (addBackground && attr.id != null) {
					
					var boundingBox = document.getElementById(attr.id).getBBox();						
					var bg = drawSVGobj(svg, "rect", {class: "barLabelBg", 	x: boundingBox.x - textLabelPadding,
																y: boundingBox.y - textLabelPadding,
																width: boundingBox.width + 2*textLabelPadding,
																height: boundingBox.height + 2*textLabelPadding,
																style: "fill:#d3d3d3"});
				
					$(bg).prev().insertAfter($(bg));

				}

				
				return newObj;

			}	



			function makeItGlow(ele, remainingFlashes = 3){

				if (remainingFlashes <= 0) return;


				ele.addClass("glowing");

				
				setTimeout(function() { 
					ele.removeClass("glowing");
					setTimeout(function() { 
						makeItGlow(ele, remainingFlashes-1);
					}, 300);
				}, 300);

			}


			function highlightNode(id){
			
				//console.log("highlighting", id);
				$("#" + id).attr("fill", "#008cba");
				$("#" + id).attr("opacity", "0.5");

			}


			function hoverNode(id){

			

				unhover();

				$("#" + id).attr("fill", "#DB5079");

				if(SPECIES_TREE_X != null) highlightNode(SPECIES_TREE_X.htmlID + "_P");


				if($("#" + id).attr("name") == null) return;

				$("#currentNodeName").html("(" + $("#" + id).attr("name") + ")");


				//console.log("node.id", id);

				var treeName = id.split("_")[0];

			
				var tree = treeName == "speciestree" ? SPECIES_TREE : GENE_TREES[parseFloat(treeName.split("gene")[1])];
				var nodeID = parseFloat(id.split("_")[1]);



				if (treeName != "speciestree") {
					$(`[branchfornode="` + id + `"].genebranch`).css("stroke", "#DB5079");
					$(`[branchfornode="` + id + `"].genebranch`).css("stroke-width", "3px");
				}else {
					$("#" + id).attr("opacity", "0.5");
					
					// Get the node
					for (var s = 0; s < SPECIES_TREE.nodeList.length; s++){
						if (SPECIES_TREE.nodeList[s].id == nodeID){
							var node = SPECIES_TREE.nodeList[s];
							for (var m in node.branchToGeneNodeMap[0]){
								$("#gene0_" + m).attr("fill", "#DB5079");
							}
							
							for (var m in node.nodeToGeneBranchMap[0]){
								$(`[branchfornode="gene0_` + m + `"].genebranch`).css("stroke", "#DB5079");
							}
							
							break;
													
							
						}
					
					}
					
				}




				var node = null;
				for (var i = 0; i < tree.nodeList.length; i ++) {
					if (tree.nodeList[i].id == nodeID) {
						node = tree.nodeList[i];
						break;
					}
				}

				$("#currentNodeTime").html(roundToSF(node.height));
				$("#currentNodeRate").html(roundToSF(node.rate));
				$("#currentNodeSize").html(roundToSF(node.populationsize));
				if (node.parent != null){
					$("#currentNodeDistance").html(roundToSF(node.rate * (node.parent.height - node.height)));
				}else {
					$("#currentNodeDistance").html("NA");
				}




			}

			function unhover(){
				$("path.node").attr("fill", "transparent");
				$("circle.node").attr("fill", "#7950DB");
				$(".node").attr("opacity", "1");
				$(".genebranch").css("stroke", "#7950DB");
				$(".genebranch").css("stroke-width", "1px");
				//$(".branch").css("stroke", "black");
				$(".currentNodeInfo").html("");
			}




			function loadFileAsString(url, resolve = function(result) { }){
			    
				console.log("Trying to open", url);
				var xhttp = new XMLHttpRequest();
					xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {

						if (xhttp == null || xhttp.responseXML == "") return resolve( {error: "Error: cannot open " + url});
						var str = xhttp.responseText;
						resolve(str);

					}
				}
				xhttp.open("GET", url, true);
			    	xhttp.send();

			}



		
			// Loads a .csv file and returns as an object
			function loadCSV(url, resolve = function(result) { }){
			    
			    console.log("Trying to open", url);
			    var xhttp = new XMLHttpRequest();
			    xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
				  
				    if (xhttp == null || xhttp.responseXML == "") return resolve( {error: "Error: cannot open " + url});

				    //console.log("xhttp.responseText", xhttp.responseText);
				    var csvString = xhttp.responseText.split("\n");
						if (csvString.length == 0)  return resolve( {error: "Error: empty csv file detected at " + url} );
						
						
						var CSV_obj = {};
						var column_names = [];
						
						
						// Parse the file
						var haveParsedHeader = false;
						var nrows = 0;
						for (var i = 0; i < csvString.length; i ++){
							var line = csvString[i].trim();
							if (line == "") continue;
							
							var splitLine = line.split("\t");
							
							
							
							
							var rowIsHeader = false;
							for (var j = 0; j < splitLine.length; j ++){
							
								// Parse the header
								if (!haveParsedHeader){
									rowIsHeader = true;
									
									column_names.push(splitLine[j]);
									CSV_obj[splitLine[j]] = [];
									
									

								
								} else {
								
									var value = splitLine[j];
									var colName = column_names[j];
									if (colName == null)  return resolve( {error: "Error: too many columns in row " + i + " of file " + url} );
									
									CSV_obj[colName].push(value);
									
									
								
								}
								
							}
							
							if (rowIsHeader) haveParsedHeader = true;
							else nrows ++;
						
						
						}
				    

						CSV_obj.nrows = nrows;
						return resolve(CSV_obj);

				   
				}
			    };
			    xhttp.open("GET", url, true);
			    xhttp.send();
			    
			    
			}




			function roundToSF(val, sf=2, ceilOrFloor = "none", precise = true){
				
				var magnitude = Math.floor(log(val, 10));

				if (val < 0 && ceilOrFloor == "ceil") ceilOrFloor = "floor";
				else if (val < 0 && ceilOrFloor == "floor") ceilOrFloor = "ceil";

				var num = val * tenToThePowerOf(sf-magnitude, precise);
				if (ceilOrFloor == "ceil") num = Math.ceil(num)
				else if (ceilOrFloor == "floor") num = Math.floor(num)
				else num = Math.round(num);

				num = num * tenToThePowerOf(magnitude-sf, precise);
				
				// Sometimes this picks up a trailing .00000000001 which we want to remove

				var expectedStringLength = 0;
				if (magnitude >= 0) expectedStringLength = magnitude >= sf ? magnitude+1 : sf+2; // Add 1 for the decimal point
				else expectedStringLength = 2 -magnitude + sf;
				if (num < 0) expectedStringLength++; // Also need the negative symbol



				num = parseFloat(num.toString().substring(0, expectedStringLength+1));
				
				return num;
					
			}




			// Compute 10^n without using Math.pow for negative n which presents numerical instabilities
			function tenToThePowerOf(n, precise = true){

				if (!precise) return Math.pow(10, n);

				if (n == Infinity || n == -Infinity) return n;

				if (n == 0) return 1;
				var val = "1";
				if (n < 0) {
				
				
					for (var index = -1; index > n; index --){
						val = "0" + val;
					}
					val = "." + val;
				}

				else if (n > 0) {
					return Math.pow(10, n);

				}
				else {
					return 1;
				}
				//console.log(n, "->", parseFloat(val));
				return parseFloat(val);


			}


			function log(num, base = null){
				
				if (num == 0) return 0;
				if (base == null) return Math.log(Math.abs(num));
				return Math.log(Math.abs(num)) / Math.log(base);
				
				
			}




		</script>

	</head>
	<body  onload="init()">



		<div style="width:70%;  min-width:900px; margin-left:15%; text-align:center; border-style:solid; border-radius:5px; border-width:0.5px; background-color:white; border-color:#696969">

			<h1 style="margin-bottom:0px">ConstantDistanceSpeciesTree operator</h1><br>
			<table style="vertical-align:top; text-align:center; width:100%; padding: 20" cellpadding=0 cellspacing=0>
				<tr>


					<td  style="width:50px"></td>

					<td  style="vertical-align:top; width:700px">
						<svg id="tree" style=" border-style:solid; border-radius:5px; border-width:0.5px;" height = 0 width = 0>
						</svg>
					</td>


					<td style="vertical-align:bottom; width:200px">

						

						<div id="operatorPanel"></div> <br><br><br>


						<span class="button" onclick="operate()">Apply operator</span> <br><br>


						<div style="text-align:left; margin-left: 10px">
							<span title="Window size" style="padding:5"> $w$ = <input onchange="updateAlphaWindow()" type="number" min=0 step=0.0005 id="windowInput" value=0.01 style="width: 80px; padding:5; margin-bottom:5px"></span>  <br>
							<span title="Sampled alpha" style="padding:5"> $\alpha$ = <span id="sampledAlpha" style="padding:5; margin-right:20px"></span></span> <br> 
						</div> <br>
		
						
						<span class="button" onclick="prevTree()">Prev tree</span> 
							<span id="treeNum"></span>
						<span class="button" onclick="nextTree()">Next tree</span><br><br>
						
						<div style="color:white; word-break: break-all; border-radius:5px; text-align:left; font-size:120%; padding: 20; border-style:solid; background-color:#DB5079">
							<div style="text-align:center">
								<b>Selected node</b><br>
								<i class="currentNodeInfo" id="currentNodeName"></i><br>
							</div> 

							<span title="Time / height"> $t$ = <span class="currentNodeInfo" id="currentNodeTime" style="padding:5; margin-right:20px"></span></span> <br> 
							<span title="Rate of above branch"> $r$ = <span class="currentNodeInfo"  id="currentNodeRate" style="padding:5; margin-right:20px"></span></span> <br>
							<span title="Genetic distance of above branch"> $d$ = <span class="currentNodeInfo"  id="currentNodeDistance" style="padding:5; margin-right:20px"></span></span> <br>
							<span title="Effective population size of above branch"> $N$ = <span class="currentNodeInfo"  id="currentNodeSize" style="padding:5; margin-right:20px"></span></span> <br>
						</div>


					</td>

					<td  style="width:50px"></td>

				</tr>
			</table>

			<br><br><br>
		</div>
			
		<br><br><br><br><br><br><br><br><br><br><br><br>


	</body>




</html>
